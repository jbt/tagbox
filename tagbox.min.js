var n=!0,q=!1;
(function(i,A,s){function B(d,b){function a(o){o=new C(o,b);o.a.insertBefore(h);c.b.push(o);h.val("");f();k.hide();p()}function g(o,a){o.remove();var b=c.b.indexOf(o);c.b.splice(b,1);o===j&&(j=s);p();f(n);a&&(-1===a?m(c.b[b-1]):1===a&&m(c.b[b]))}function p(){for(var o=[],a=0;a<c.b.length;a+=1)o.push(c.b[a].value);e.val(o.join(b.delimiter))}function m(c){j&&j.f();j!==c?(j=c,c.select()):j=s}function r(){j&&(j.f(),j=s)}function D(){var c=b.searchIn;"string"==typeof c&&(c=[c]);if(i.isArray(c)){for(var a={},
f=0;f<c.length;f+=1)a[c[f]]=10;return a}return c}function w(a){for(var b=0;b<c.b.length;b+=1)if(c.b[b].item===a)return n;return q}function u(){var c=b.items,a=[],f=h.val(),e=D();if(""===f)k.hide();else{for(var g=0;g<c.length;g+=1){var d={item:c[g],i:E(c[g],f,e)};0<d.i&&(b.allowDuplicates||!w(d.item))&&a.push(d)}a=a.sort(function(c,a){return a.i-c.i});for(g=0;g<a.length;g+=1)a[g]=a[g].item;k.r(a);k.q(f)}}function f(a){c.k==h.val()&&a!==n||(r(),c.k=h.val(),y.text(c.k),h.width(0),h.width(Math.min(c.j.width()-
8,Math.max(c.j.width()-h.offset().left+c.j.offset().left-8,y.width()+20))),k.s(x))}var c=this;c.b=[];var e=c.input=i(d).hide();c.options=b;var x=c.j=i('<div class="tagbox-wrapper" />').click(function(c){var a=i(c.target).closest("input, .tagbox-token, .tagbox-wrapper");a.is(".tagbox-token")?i(c.target).is("a")?g(a.data("token")):m(a.data("token")):r();h.focus()}).insertBefore(c.input),h=i('<input type="text" />').bind("keyup keydown blur update change",f).bind("blur",function(){setTimeout(function(){c.l||
k.hide()},50)}).bind("keydown",function(f){var e=h.val().length==h[0].selectionStart,d=0===h[0].selectionEnd;if(37===f.keyCode){if(j)return j===c.b[0]?r():m(c.b[c.b.indexOf(j)-1]),q;d&&c.b.length&&m(c.b[c.b.length-1])}if(39===f.keyCode){if(j)return j===c.b[c.b.length-1]?r():m(c.b[c.b.indexOf(j)+1]),q;e&&c.b.length&&m(c.b[0])}if(j&&(46===f.keyCode||8===f.keyCode))return g(j,8===f.keyCode?-1:1),q;if(8===f.keyCode&&d&&c.b.length)return m(c.b[c.b.length-1]),q;if(h.val()){if(38===f.keyCode)return k.p(),
q;if(40===f.keyCode)return k.o(),q;if(39==f.keyCode&&e||13==f.keyCode||9==f.keyCode)return(f=k.d.item)?a(f):b.allowNew&&a(b.createNew(h.val())),q}else if(13==f.keyCode||9==f.keyCode)return q;setTimeout(u,10)}).appendTo(x),y=i("<span />").appendTo(x).css({position:"absolute",left:-99999,width:"auto",display:"inline-block",whiteSpace:"nowrap",fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),fontWeight:e.css("fontWeight"),fontVariant:e.css("fontVariant"),letterSpacing:e.css("letterSpacing")}),
k=c.t=new F(c,b);k.a.appendTo(b.dropdownContainer);if(e.val())for(var l=b.items,z=e.val().split(b.delimiter),v=0;v<z.length;v+=1)for(var t=0;t<l.length;t+=1)if(l[t][b.valueField]==z[v]){a(l[t]);break}f(n);i(A).bind("resize",function(){f(n)});c.m=a;var j}function C(d,b){var a=this.a=i('<div class="tagbox-token"><span></span><a>&times;</a></div>').data("token",this),g=b.tokenFormat;"string"==typeof g?a.children("span").html(g.replace(/\{\{([^}]*)\}\}/g,function(a,b){return d[b]})):a.children("span").html(g(d));
this.value=d[b.valueField];this.item=d;this.remove=function(){this.a.data("token",null);this.a.remove();this.a=this.item=null};this.select=function(){this.a.addClass("selected")};this.f=function(){this.a.removeClass("selected")}}function F(d,b){this.a=i('<div class="tagbox-dropdown"><div class="list"></div></div>').css({maxHeight:b.maxHeight}).hide();b.allowNew&&(this.h=i('<div class="tagbox-item new-item" />').prependTo(this.a));this.s=function(a){this.a.offset();var b=a.offset(),d=this.a.parent().offset();
this.a.parent().is("body")&&(d={top:0,left:0});this.a.css({top:b.top-d.top+a.height()+1,left:b.left-d.left,width:a.outerWidth()})};this.show=function(){this.a.show()};this.hide=function(){this.a.hide()};this.o=function(){this.selectedIndex===this.rows.length-1?b.allowNew||this.rows.length===0?this.c(-1):this.c(0):this.c(this.selectedIndex+1)};this.p=function(){if(this.selectedIndex===0)b.allowNew?this.c(-1):this.c(this.rows.length-1);else{if(this.selectedIndex===-1)this.selectedIndex=this.rows.length;
this.c(this.selectedIndex-1)}};this.c=function(a){this.d&&this.d.f();this.h&&this.h.removeClass("selected");typeof a!=="number"&&(a=this.rows.indexOf(a));if(a>=0){this.d=this.rows[a];this.d.select();this.n(this.d.a)}else{this.d=q;this.h&&this.h.addClass("selected")}this.selectedIndex=a};this.n=function(a){var b=a.offset().top-this.a.offset().top-this.a.scrollTop();b<0?this.a.scrollTop(a.offset().top-this.a.offset().top):b>this.a.height()-a.height()&&this.a.scrollTop(b+this.a.scrollTop()-this.a.height()+
a.height())};this.q=function(a){this.a.find(".new-item").text(b.newText.replace(/\{\{txt\}\}/g,a))};this.r=function(a){this.a.find(".list").empty();this.rows=[];if(a.length>0){for(var g=0;g<Math.min(a.length,b.maxItems);g=g+1){var p=new G(a[g],b);p.a.appendTo(this.a.find(".list"));p.a.on("mouseover",function(a,b){return function(){a.c(b)}}(this,p));p.a.on("mousedown",function(){d.l=n}).on("mouseup",function(){d.l=q});p.a.on("click",function(a){return function(){d.m(a)}}(a[g]));this.rows.push(p)}this.c(0)}else{i('<div class="tagbox-item empty"/>').text(b.emptyText).appendTo(this.a.find(".list"));
this.c(-1)}this.show()}}function G(d,b){this.a=i('<div class="tagbox-item" />');b.itemClass&&this.a.addClass(b.itemClass);this.item=d;var a=b.rowFormat;"string"==typeof a?this.a.html(a.replace(/\{\{([^}]*)\}\}/g,function(a,b){return d[b]})):this.a.html(a(d));this.select=function(){this.a.addClass("selected")};this.f=function(){this.a.removeClass("selected")}}var E=function(){function d(a){return a.replace(/[\[\]\{\}\(\)\^\$\.\*\+\|]/g,function(a){return"\\"+a})}function b(a){return/[a-z]/.test(a)?
m:/[A-Z]/.test(a)?i:/[0-9]/.test(a)?r:/[\/\-_\.]/.test(a)?s:w}function a(a,c,e){a=b(a);return u[a][b(c)]+0.4*u[a][b(e)]}function g(b,c,e){if(0===c.length)return 100*e/b.length;if(0===b.length||!b.slice(e).match(RegExp(("^"+d(c)+"$").split("").join(".*"),"i")))return-1;for(var i=c.charAt(0),h=-1,m;e<b.length;e+=1)if(b.charAt(e).toLowerCase()===i.toLowerCase()){var k=g(b.substr(e),c.slice(1),1);if(-1!=k){var l=400/Math.max(1,e);0===b.substr(e).toLowerCase().indexOf(c.toLowerCase())&&(l+=3*c.length*
c.length);l+=a(b.charAt(e),0===e?"/":b.charAt(e-1),e===b.length-1?"/":b.charAt(e+1));l+=k;if(l>h){h=l;m=[e];k=k.g||[];for(l=0;l<k.length;l+=1)m.push(k[l]+e)}}}return{e:h,valueOf:function(){return this.e},g:m}}var i=0,m=1,r=2,s=3,w=4,u=[[0,240,120,240,220],[20,0,20,120,120],[140,140,0,140,140],[120,120,120,0,120],[120,120,120,160,0]];return function(a,c,b){if("string"==typeof a)return g(a,c,0);var d={e:0,valueOf:function(){return this.e},g:{}},h;for(h in b)if(b.hasOwnProperty(h)&&a.hasOwnProperty(h)){var i=
g(a[h],c,0);d.e+=b[h]*i;d.g[h]=0<i?i.g:[]}return d}}();i.fn.tagbox=function(d){var b=i.extend({},{maxHeight:200,maxItems:20,rowFormat:"{{name}}",tokenFormat:"{{name}}",valueField:"name",delimiter:",",allowDuplicates:q,createNew:function(a){return{name:a}},allowNew:q,newText:"{{txt}}",emptyText:"Not Found",dropdownContainer:"body"},d);return this.each(function(){var a=new B(this,b);i(this).data("tagbox",a)})}})(jQuery,window);
